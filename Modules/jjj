local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local ZoneConfig = require(script.Parent.ZoneConfig)
local Events = script.Parent.Events

-- Crear RemoteEvents
local Remotes = Instance.new("Folder")
Remotes.Name = "ZoneRemotes"
Remotes.Parent = ReplicatedStorage

local ZoneStatus = Instance.new("RemoteEvent")
ZoneStatus.Name = "ZoneStatus"
ZoneStatus.Parent = Remotes

local EventWarning = Instance.new("RemoteEvent")
EventWarning.Name = "EventWarning"
EventWarning.Parent = Remotes

local EventStart = Instance.new("RemoteEvent")
EventStart.Name = "EventStart"
EventStart.Parent = Remotes

local EventEnd = Instance.new("RemoteEvent")
EventEnd.Name = "EventEnd"
EventEnd.Parent = Remotes

-- Sistema principal
local ZoneSystem = {
    SafeZones = {},
    DangerZones = {},
    ActivePlayers = {},
    CurrentEvent = nil,
    IsEventActive = false
}

-- Inicializar zonas desde Workspace
function ZoneSystem:InitializeZones()
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") then
            if obj.Name == "SafeZone" then
                table.insert(self.SafeZones, obj)
                obj.Color = ZoneConfig.SafeZones.Color
                obj.Transparency = ZoneConfig.SafeZones.Transparency
                obj.Material = Enum.Material.Neon
                
                -- A√±adir indicador visual
                self:CreateZoneIndicator(obj, "SAFE")
                
            elseif obj.Name == "DangerZone" then
                table.insert(self.DangerZones, obj)
                obj.Color = ZoneConfig.DangerZones.Color
                obj.Transparency = ZoneConfig.DangerZones.Transparency
                obj.Material = Enum.Material.Neon
                
                self:CreateZoneIndicator(obj, "DANGER")
            end
        end
    end
end

-- Crear indicador visual flotante
function ZoneSystem:CreateZoneIndicator(zone, text)
    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 5, 0)
    billboard.AlwaysOnTop = true
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = "üè† " .. text .. " ZONE"
    label.TextColor3 = text == "SAFE" and Color3.fromRGB(0, 255, 100) or Color3.fromRGB(255, 100, 100)
    label.TextStrokeTransparency = 0
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold
    label.Parent = billboard
    
    billboard.Parent = zone
    
    -- Animaci√≥n flotante
    spawn(function()
        while zone and zone.Parent do
            local tween = TweenService:Create(zone, TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
                Position = zone.Position + Vector3.new(0, 0.5, 0)
            })
            tween:Play()
            tween.Completed:Wait()
            
            local tween2 = TweenService:Create(zone, TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
                Position = zone.Position - Vector3.new(0, 0.5, 0)
            })
            tween2:Play()
            tween2.Completed:Wait()
        end
    end)
end

-- Verificar si un punto est√° en zona segura
function ZoneSystem:IsInSafeZone(position)
    for _, zone in pairs(self.SafeZones) do
        local bounds = zone.Size / 2
        local relativePos = position - zone.Position
        
        if math.abs(relativePos.X) <= bounds.X and
           math.abs(relativePos.Y) <= bounds.Y and
           math.abs(relativePos.Z) <= bounds.Z then
            return true
        end
    end
    return false
end

-- Verificar si jugador est√° protegido
function ZoneSystem:IsPlayerProtected(player)
    local character = player.Character
    if not character then return false end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    
    return self:IsInSafeZone(hrp.Position)
end

-- Aplicar da√±o con protecci√≥n de zona segura
function ZoneSystem:ApplyDamage(player, amount, damageType)
    if self:IsPlayerProtected(player) then
        -- Notificar al jugador que est√° protegido
        ZoneStatus:FireClient(player, "PROTECTED", damageType)
        return false
    end
    
    local character = player.Character
    if not character then return false end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return false end
    
    humanoid:TakeDamage(amount)
    ZoneStatus:FireClient(player, "DAMAGED", damageType, amount)
    return true
end

-- Iniciar ciclo de eventos aleatorios
function ZoneSystem:StartEventCycle()
    spawn(function()
        while true do
            local waitTime = math.random(ZoneConfig.EventInterval.min, ZoneConfig.EventInterval.max)
            wait(waitTime)
            
            if not self.IsEventActive then
                self:StartRandomEvent()
            end
        end
    end)
end

-- Iniciar evento aleatorio
function ZoneSystem:StartRandomEvent()
    local events = {"Lava", "Storm", "ToxicGas", "Meteor"}
    local selectedEvent = events[math.random(1, #events)]
    
    self:TriggerEvent(selectedEvent)
end

-- Ejecutar evento espec√≠fico
function ZoneSystem:TriggerEvent(eventName)
    if self.IsEventActive then return end
    
    self.IsEventActive = true
    self.CurrentEvent = eventName
    
    -- Advertencia previa (5 segundos)
    EventWarning:FireAllClients(eventName, 5)
    wait(5)
    
    -- Iniciar evento
    EventStart:FireAllClients(eventName)
    print("üö® Evento iniciado: " .. eventName)
    
    -- Cargar y ejecutar m√≥dulo de evento
    local eventModule = require(Events:FindFirstChild(eventName .. "Event"))
    eventModule.Start(self)
    
    -- Esperar duraci√≥n del evento
    local duration = ZoneConfig.Events[eventName].Duration
    wait(duration)
    
    -- Finalizar evento
    eventModule.Stop(self)
    self.IsEventActive = false
    self.CurrentEvent = nil
    EventEnd:FireAllClients(eventName)
    
    print("‚úÖ Evento finalizado: " .. eventName)
end

-- Inicializaci√≥n
function ZoneSystem:Init()
    self:InitializeZones()
    self:StartEventCycle()
    
    -- Monitorear jugadores
    Players.PlayerAdded:Connect(function(player)
        self.ActivePlayers[player] = true
        
        player.CharacterAdded:Connect(function(char)
            wait(1) -- Esperar a que cargue el personaje
            ZoneStatus:FireClient(player, "INIT", self.SafeZones, self.DangerZones)
        end)
    end)
    
    Players.PlayerRemoving:Connect(function(player)
        self.ActivePlayers[player] = nil
    end)
    
    print("‚úÖ ZoneSystem inicializado. Zonas seguras: " .. #self.SafeZones .. ", Zonas peligrosas: " .. #self.DangerZones)
end

-- Iniciar sistema
ZoneSystem:Init()
